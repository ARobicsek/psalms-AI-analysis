#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""Direct database test to understand word variations matching"""

import sqlite3
import sys
import os

def test_database():
    """Test database directly with SQL queries"""
    db_path = "c:/Users/ariro/OneDrive/Documents/Psalms/database/tanakh.db"

    conn = sqlite3.connect(db_path)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    output = []

    # Test 1: Check if Psalm 15:1 contains "יגור"
    output.append("=== Test 1: Direct query for יגור in Psalm 15:1 ===")
    cursor.execute("""
        SELECT word, word_consonantal, word_consonantal_split, position
        FROM concordance
        WHERE book_name = 'Psalms' AND chapter = 15 AND verse = 1
        ORDER BY position
    """)

    psalm_15_1 = cursor.fetchall()
    output.append(f"Psalm 15:1 has {len(psalm_15_1)} words:")
    for row in psalm_15_1:
        output.append(f"  Position {row['position']}: {row['word']} | {row['word_consonantal']} | {row['word_consonantal_split']}")

    # Test 2: Check for any verse containing "יגור"
    output.append("\n=== Test 2: Any verse with word_consonantal_split = 'יגור' ===")
    cursor.execute("""
        SELECT book_name, chapter, verse, word
        FROM concordance
        WHERE word_consonantal_split = 'יגור'
        LIMIT 10
    """)

    yigurot = cursor.fetchall()
    output.append(f"Found {len(yigurot)} instances of 'יגור':")
    for row in yigurot:
        output.append(f"  {row['book_name']} {row['chapter']}:{row['verse']} - {row['word']}")

    # Test 3: Generate variations for "גור" and check if they're in DB
    output.append("\n=== Test 3: Generate variations for 'גור' ===")

    # Simulate variation generation
    base_word = "גור"
    prefixes = ["", "ו", "ב", "ל", "מ", "כ", "ה", "ש"]
    suffixes = ["", "ו", "ך", "י", "נו", "ם", "ן", "ה", "יך", "יו", "יה", "ינו", "יכם", "יכן"]

    variations = set()
    for prefix in prefixes:
        for suffix in suffixes:
            variations.add(prefix + base_word + suffix)

    output.append(f"Generated {len(variations)} variations for 'גור'")

    # Check if any of these variations are in Psalm 15
    output.append("\nChecking if any variations appear in Psalm 15...")
    found_in_psalm = []
    for variation in variations:
        cursor.execute("""
            SELECT chapter, verse, position
            FROM concordance
            WHERE book_name = 'Psalms' AND chapter = 15
            AND word_consonantal_split = ?
        """, (variation,))
        results = cursor.fetchall()
        if results:
            found_in_psalm.append((variation, results))

    for variation, results in found_in_psalm:
        output.append(f"  Found '{variation}' in Psalm 15:")
        for r in results:
            output.append(f"    Verse {r['verse']}, position {r['position']}")

    # Test 4: Check what words are actually in Psalm 15
    output.append("\n=== Test 4: All words in Psalm 15 ===")
    cursor.execute("""
        SELECT DISTINCT word_consonantal_split
        FROM concordance
        WHERE book_name = 'Psalms' AND chapter = 15
        AND word_consonantal_split IS NOT NULL AND word_consonantal_split != ''
        ORDER BY word_consonantal_split
    """)

    all_words = [row[0] for row in cursor.fetchall()]
    output.append(f"Psalm 15 has {len(all_words)} unique consonantal-split words")

    # Check for words that contain "גור"
    gur_words = [w for w in all_words if "גור" in w]
    output.append(f"\nWords in Psalm 15 containing 'גור': {gur_words}")

    conn.close()

    # Write to file
    with open("test_db_output.txt", "w", encoding="utf-8") as f:
        f.write("\n".join(output))

    print("Results written to test_db_output.txt")

if __name__ == "__main__":
    try:
        test_database()
    except Exception as e:
        print(f"Error: {e}")
        import traceback
        traceback.print_exc()